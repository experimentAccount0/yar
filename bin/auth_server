#!/usr/bin/env python
"""This module contains the core logic for the authenication server.
The server uses implements MAC Access Authentication."""

import logging
import time

import tornado.httpserver
import tornado.web

from yar.auth_server import async_app_server_forwarder
from yar.auth_server.basic import async_creds_retriever
from yar.auth_server.mac import async_mac_creds_retriever
from yar.auth_server.mac import async_mac_auth
from yar.auth_server.mac import async_nonce_checker
from yar.auth_server import auth_server_request_handler
from yar.auth_server import clparser
from yar.util import logging_config
from yar.util import tsh

_logger = logging.getLogger("AUTHSERVER.%s" % __name__)


if __name__ == "__main__":
    clp = clparser.CommandLineParser()
    (clo, cla) = clp.parse_args()

    logging_config.configure(
        clo.logging_level,
        clo.logging_file,
        clo.syslog)

    tsh.install()

    fmt = (
        "Auth Server listening on {clo.listen_on} "
        "using Nonce Store {clo.nonce_store}, "
        "Key Server '{clo.key_server}' "
        "and App Server '{clo.app_server}'"
    )
    _logger.info(fmt.format(clo=clo))

    async_creds_retriever.key_server_address = clo.key_server
    async_mac_creds_retriever.key_server_address = clo.key_server
    async_mac_auth.maxage = clo.maxage
    async_nonce_checker.nonce_store = clo.nonce_store
    async_app_server_forwarder.app_server = clo.app_server
    async_app_server_forwarder.auth_method = clo.app_server_auth_method

    handlers = [
        (
            auth_server_request_handler.url_spec,
            auth_server_request_handler.RequestHandler
        ),
    ]
    app = tornado.web.Application(handlers=handlers)

    http_server = tornado.httpserver.HTTPServer(app)
    http_server.listen(
        port=clo.listen_on[1],
        address=clo.listen_on[0])

    tornado.ioloop.IOLoop.instance().start()
