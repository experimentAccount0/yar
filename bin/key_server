#!/usr/bin/env python
"""The key server's mainline."""

import logging
import time

import tornado.httpserver
import tornado.web

from yar.key_server import clparser
from yar.key_server import key_server_request_handler
from yar.util import tsh

_logger = logging.getLogger("KEYSERVER.%s" % __name__)


if __name__ == "__main__":
    clp = clparser.CommandLineParser()
    (clo, cla) = clp.parse_args()

    logging.Formatter.converter = time.gmtime
    format = (
        "%(asctime)s;%(levelname)s;%(name)s."
        "%(funcName)s:%(lineno)d;%(message)s"
    )
    logging.basicConfig(
        level=clo.logging_level,
        format=format,
        filename=clo.logging_file)

    if clo.syslog:
        handler = logging.handlers.SysLogHandler(address=clo.syslog)
        logging.getLogger().addHandler(handler)

    tsh.install()

    key_server_request_handler._key_store = clo.key_store

    _logger.info(
        "Key server listening on '%s' and using key store '%s'",
        clo.listen_on,
        clo.key_store)

    handlers = [
        (
            key_server_request_handler.url_spec,
            key_server_request_handler.RequestHandler
        ),
    ]

    app = tornado.web.Application(handlers=handlers)

    http_server = tornado.httpserver.HTTPServer(app)
    for address_and_port in clo.listen_on:
        http_server.listen(
            port=address_and_port[1],
            address=address_and_port[0])
    tornado.ioloop.IOLoop.instance().start()
