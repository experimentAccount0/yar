#!/usr/bin/env python
"""The key server's mainline."""

import logging

import tornado.httpserver
import tornado.web

from yar.key_server import clparser
from yar.key_server import key_server_request_handler
from yar.util import tsh
from yar.util import logging_config

_logger = logging.getLogger("KEYSERVER.%s" % __name__)


if __name__ == "__main__":
    clp = clparser.CommandLineParser()
    (clo, cla) = clp.parse_args()

    logging_config.configure(
        clo.logging_level,
        clo.logging_file,
        clo.syslog)

    tsh.install()

    key_server_request_handler._key_store = clo.key_store

    _logger.info(
        "Key server listening on '%s' and using key store '%s'",
        clo.listen_on,
        clo.key_store)

    handlers = [
        (
            key_server_request_handler.url_spec,
            key_server_request_handler.RequestHandler
        ),
    ]

    app = tornado.web.Application(handlers=handlers)

    http_server = tornado.httpserver.HTTPServer(app)
    http_server.listen(
        port=clo.listen_on[1],
        address=clo.listen_on[0])

    tornado.ioloop.IOLoop.instance().start()
